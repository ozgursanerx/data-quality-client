create table T74840_NAME_KEY_TMP_PEM2 as 
WITH TRX_TMP AS 
(
SELECT A.*, ROW_NUMBER() OVER(PARTITION BY CUST_ID, TRX_MRCHNT_ID ORDER BY CNT DESC, LENGTH(TRX_DSC_CLN) ,TRX_DSC_CLN) AS RN FROM 
    (
    SELECT /*+ PARALLEL (8) */  CUST_ID, TRX_MRCHNT_ID, A.TRX_DSC_CLN, COUNT(TRX_DSC_CLN) CNT FROM  rbtpmtest.DA_CPR_TRX A
    WHERE 1=1 
        AND (SUBSTR(POS_ENTRY_MODE,1,2) IN  ('01', '10', '81') OR POS_ENTRY_MODE = '0') 
    GROUP BY CUST_ID, TRX_MRCHNT_ID, A.TRX_DSC_CLN
    ) A
),
CPR_TMP AS (
SELECT /*+ PARALLEL (8) */ CUST_ID, MRCHNT_ID, TRX_DSC_CLN, MRCHNT_DESC FROM 
    (SELECT /*+ PARALLEL (8) */ B.*, ' ' || TRIM(REGEXP_REPLACE(LOWER(TRANSLATE(SUBSTR(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(B.TRX_DSC), '[^[:alnum:] ]', ' '), '\d', ''), 1, 50 ),'ĞÜŞİÖÇÒÕÚÂÃÅÀÁÄÆÈÉËÊÏÎÌÍÑÔÔÓØßÛÙ','GUSIOCOOUAAAAAAAEEEEIIIOOOOSUU')),'[ ]+', ' ')) || ' ' as TRX_DSC_CLN 
    FROM rbtpmtest.DA_CPR_PATTERN_FINAL B --EDW.DA_CARDPLATFORM_REMINDER B
    WHERE 1=1 
    -- AND B.VERSION_ID = 1
    -- AND B.AS_OF_DT= TRUNC(SYSDATE-1)
        )
GROUP BY CUST_ID, MRCHNT_ID, TRX_DSC_CLN, MRCHNT_DESC
),
PEM_TMP AS (
    SELECT DISTINCT 
           T.CUST_ID,
           T.TRX_MRCHNT_ID, 
           T.TRX_DSC_CLN,
           FIRST_VALUE(P.MRCHNT_DESC) OVER (
               PARTITION BY T.CUST_ID, T.TRX_MRCHNT_ID, T.TRX_DSC_CLN
               ORDER BY P.PRIORITY_F ASC NULLS LAST,  -- Explicit ASC sorting
                        LENGTH(P.TRX_DSC) DESC       -- Longer patterns first
           ) AS MRCHNT_DESC
    FROM lookup.da_cardplatform_pem P
    JOIN TRX_TMP T ON T.TRX_DSC_CLN LIKE '%' || P.TRX_DSC || '%'
    WHERE (P.TRX_DSC_NOT IS NULL OR 
           T.TRX_DSC_CLN NOT LIKE '%' || P.TRX_DSC_NOT || '%')
) 
    SELECT /*+ PARALLEL (8) */ 
    A.CUST_ID,
    A.TRX_MRCHNT_ID,
    A.TRX_DSC_CLN as TRX_DSC_CLN_TRX,
     B.MRCHNT_DESC,
    FIRST_VALUE(COALESCE(P.MRCHNT_DESC, B.MRCHNT_DESC)) OVER (
        PARTITION BY A.TRX_DSC_CLN
        ORDER BY CASE WHEN P.MRCHNT_DESC IS NOT NULL THEN 1 ELSE 2 END,
                 B.MRCHNT_DESC
    ) AS MRCHNT_DSC_NEW
FROM TRX_TMP A, CPR_TMP B, PEM_TMP P
WHERE 1=1 
    AND A.CUST_ID = B.CUST_ID (+)
    AND A.TRX_MRCHNT_ID = B.MRCHNT_ID (+)
    AND A.TRX_DSC_CLN = B.TRX_DSC_CLN (+)
    AND A.CUST_ID = P.CUST_ID (+)
    AND A.TRX_MRCHNT_ID = P.TRX_MRCHNT_ID (+)
    AND A.TRX_DSC_CLN = P.TRX_DSC_CLN (+)
    AND A.RN = 1
